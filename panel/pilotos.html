<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti√≥n de Pilotos | PROKART</title>

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --rojo:#e10600;
  --negro:#111;
  --gris:#f4f4f4;
}

body{
  margin:0;
  font-family:'Oswald',Arial;
  background:var(--gris);
}

header{
  background:#000;
  color:#fff;
  padding:40px 20px;
  text-align:center;
}

section{
  max-width:1000px;
  margin:auto;
  padding:40px 20px;
}

input, select{
  width:100%;
  padding:12px;
  margin-bottom:15px;
  border-radius:6px;
  border:1px solid #ccc;
  font-family:'Oswald';
  font-size:16px;
}

.categoria{
  margin-bottom:40px;
}

.categoria h2{
  border-left:5px solid var(--rojo);
  padding-left:12px;
}

.lista{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:15px;
}

.card{
  background:#fff;
  padding:18px;
  border-radius:8px;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
}

.card strong{
  display:block;
  margin-bottom:10px;
}

.btn{
  display:inline-block;
  padding:10px 14px;
  background:var(--rojo);
  color:#fff;
  text-decoration:none;
  border-radius:5px;
  font-size:14px;
  border:none;
  cursor:pointer;
}

.volver{
  text-align:center;
  margin-top:40px;
}

hr{
  margin:40px 0;
}
</style>
</head>

<body>

<header>
  <h1>Gesti√≥n de Pilotos</h1>
</header>

<section>

<h2>Agregar Nuevo Piloto</h2>

<input type="text" id="nombreNuevo" placeholder="Nombre">
  <select id="categoriaNueva">
  <option value="">Seleccionar Categor√≠a</option>
  <option value="Pre Junior">Pre Junior</option>
  <option value="Junior">Junior</option>
  <option value="110 Cajeros">110 Cajeros</option>
  <option value="200 STD">200 STD</option>
    <option value="200 Master">200 Master</option>
</select>
<input type="number" id="numeroNuevo" placeholder="N√∫mero">
<input type="text" id="localidadNueva" placeholder="Localidad">
<input type="text" id="equipoNuevo" placeholder="Equipo">
<input type="text" id="chasisNuevo" placeholder="Chasis">
<input type="text" id="motorNuevo" placeholder="Motor">
<input type="text" id="fotoNueva" placeholder="FotoURL (opcional)">
<select id="estadoNuevo">
  <option value="Activo">Activo</option>
  <option value="Inactivo">Inactivo</option>
</select>

<button class="btn" onclick="guardarPiloto()">Guardar Piloto</button>

<hr>

<input type="text" id="buscador" placeholder="Buscar piloto...">

<div id="contenedor"></div>

<div class="volver">
  <a class="btn" href="index.html">Volver al Panel</a>
</div>

</section>

<script src="auth.js"></script>

<script>

const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbysrY6r-WN3aoYLun3s5i811npVI9Tl4zDvhHAtzHgrP39yOFoxyIvBm4UgV4z-uTvE/exec";

const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhBGHo7TZ_jtqT0HXBvYaV3g1TYBN5lEfYfq2phY0vvHTEyVkTfrVy6RrotDcqVOxm5C4JX9CdTBp/pub?gid=2063656949&single=true&output=csv";

function limpiar(v){
  return v?.replace(/^"|"$/g,'').trim();
}

let pilotosGlobal = {};

fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{

  const filas = csv.split(/\r?\n/).slice(1).filter(f=>f.trim()!=='');

  const datos = filas.map(f=>{
    const col = f.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    return {
      id: limpiar(col[0]),
      categoria: limpiar(col[1]),
      numero: limpiar(col[2]),
      nombre: limpiar(col[3]),
      localidad: limpiar(col[4]),
      equipo: limpiar(col[5]),
      chasis: limpiar(col[6]),
      motor: limpiar(col[7]),
      fotoURL: limpiar(col[8]),
      estado: limpiar(col[9])
    };
  });

  const activos = datos.filter(p=>p.estado === "Activo");

  const mapa = {};

  activos.forEach(d=>{
    if(!mapa[d.categoria]) mapa[d.categoria] = [];
    mapa[d.categoria].push(d);
  });

  pilotosGlobal = mapa;
  renderizar(mapa);

});

function renderizar(mapa){

  const contenedor = document.getElementById("contenedor");
  contenedor.innerHTML = "";

  Object.keys(mapa).sort().forEach(cat=>{

    const div = document.createElement("div");
    div.className = "categoria";

    let html = `<h2>${cat} (${mapa[cat].length})</h2>`;
    html += `<div class="lista">`;

    mapa[cat]
      .sort((a,b)=>a.nombre.localeCompare(b.nombre))
      .forEach(p=>{

      html += `
  <div class="card">
    <strong>#${p.numero} - ${p.nombre}</strong>

    <a class="btn" 
       href="../piloto.html?id=${encodeURIComponent(p.id)}" 
       target="_blank">
       Ver Ficha P√∫blica
    </a>

    <br><br>

    <button class="btn"
            style="background:#555"
            onclick="desactivarPiloto('${p.id}')">
      Desactivar
    </button>
  </div>
`;
    });

    html += `</div>`;
    div.innerHTML = html;
    contenedor.appendChild(div);
  });
}

// Buscador
document.getElementById("buscador").addEventListener("input", function(){

  const texto = this.value.toLowerCase();
  const filtrado = {};

  Object.keys(pilotosGlobal).forEach(cat=>{
    const filtrados = pilotosGlobal[cat]
      .filter(p=>p.nombre.toLowerCase().includes(texto));

    if(filtrados.length>0){
      filtrado[cat] = filtrados;
    }
  });

  renderizar(filtrado);
});

function guardarPiloto(){

  const nombre = document.getElementById("nombreNuevo").value.trim();
  const categoria = document.getElementById("categoriaNueva").value.trim();
  const numero = document.getElementById("numeroNuevo").value.trim();
  const localidad = document.getElementById("localidadNueva").value.trim();
  const equipo = document.getElementById("equipoNuevo").value.trim();
  const chasis = document.getElementById("chasisNuevo").value.trim();
  const motor = document.getElementById("motorNuevo").value.trim();
  const fotoURL = document.getElementById("fotoNueva").value.trim();
  const estado = document.getElementById("estadoNuevo").value;

  if(!nombre || !categoria || !numero){
    alert("Complete Nombre, Categor√≠a y N√∫mero");
    return;
  }

  // üîπ Limpiar categor√≠a para ID
  const categoriaID = categoria
    .toUpperCase()
    .replace(/\s+/g, "")
    .replace(/[^A-Z0-9]/g, "");

  const id = categoriaID + "_" + numero;

  // üî¥ VALIDAR DUPLICADOS
  if(pilotosGlobal[categoria]){
    const existe = pilotosGlobal[categoria].some(p => p.numero === numero);
    if(existe){
      alert("Ya existe un piloto con ese n√∫mero en esta categor√≠a.");
      return;
    }
  }

  const datos = new FormData();
  datos.append("id", id);
  datos.append("categoria", categoria);
  datos.append("numero", numero);
  datos.append("nombre", nombre);
  datos.append("localidad", localidad);
  datos.append("equipo", equipo);
  datos.append("chasis", chasis);
  datos.append("motor", motor);
  datos.append("fotoURL", fotoURL);
  datos.append("estado", estado);

  fetch(APPS_SCRIPT_URL,{
    method:"POST",
    body:datos
  })
  .then(r=>r.text())
  .then(res=>{

    if(res.includes("ERROR")){
      alert(res);
      return;
    }

    alert("Piloto guardado correctamente");

    // Limpiar formulario sin recargar
    document.querySelectorAll("input").forEach(i=>i.value="");

    // Recargar lista
    location.reload();

  })
    function desactivarPiloto(id){

  if(!confirm("¬øSeguro que quer√©s desactivar este piloto?")){
    return;
  }

  const datos = new FormData();
  datos.append("accion", "desactivar");
  datos.append("id", id);

  fetch(APPS_SCRIPT_URL,{
    method:"POST",
    body:datos
  })
  .then(r=>r.text())
  .then(res=>{
    if(res.includes("ERROR")){
      alert(res);
      return;
    }

    alert("Piloto desactivado correctamente");
    location.reload();
  })
  .catch(err=>{
    console.error(err);
    alert("Error de conexi√≥n con Apps Script");
  });
}

</script>
  

</body>
</html>
