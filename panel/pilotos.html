<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti√≥n de Pilotos | PROKART</title>

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --rojo:#e10600;
  --negro:#111;
  --gris:#f4f4f4;
}

body{
  margin:0;
  font-family:'Oswald',Arial;
  background:var(--gris);
}

header{
  background:#000;
  color:#fff;
  padding:40px 20px;
  text-align:center;
}

section{
  max-width:1100px;
  margin:auto;
  padding:40px 20px;
}

input{
  width:100%;
  padding:12px;
  margin-bottom:25px;
  border-radius:6px;
  border:1px solid #ccc;
  font-family:'Oswald';
}

.categoria{
  margin-bottom:40px;
}

.categoria h2{
  border-left:5px solid var(--rojo);
  padding-left:12px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
}

.card{
  background:#fff;
  padding:20px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

.card img{
  width:100%;
  height:180px;
  object-fit:cover;
  border-radius:8px;
  margin-bottom:10px;
}

.btn{
  display:inline-block;
  margin-top:10px;
  padding:8px 12px;
  background:var(--rojo);
  color:#fff;
  text-decoration:none;
  border-radius:5px;
  font-size:14px;
}

.falta-foto{
  color:red;
  font-size:13px;
  margin-top:5px;
}

.volver{
  text-align:center;
  margin-top:40px;
}
</style>
</head>

<body>

<header>
  <h1>Gesti√≥n de Pilotos</h1>
</header>

<section>

<input type="text" id="buscador" placeholder="Buscar piloto...">

<div id="contenedor"></div>

<div class="volver">
  <a class="btn" href="index.html">Volver al Panel</a>
</div>

</section>

<script src="auth.js"></script>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhBGHo7TZ_jtqT0HXBvYaV3g1TYBN5lEfYfq2phY0vvHTEyVkTfrVy6RrotDcqVOxm5C4JX9CdTBp/pub?gid=368482217&single=true&output=csv";

function limpiar(v){
  return v?.replace(/^"|"$/g,'').trim();
}

let pilotosGlobal = [];

fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{

  const filas = csv.split(/\r?\n/).slice(1)
    .filter(f=>f.trim()!=='');

  const datos = filas.map(f=>{
    const col = f.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    return {
      categoria: limpiar(col[2]),
      piloto: limpiar(col[3])
    };
  });

  // Pilotos √∫nicos por categor√≠a
  const mapa = {};

  datos.forEach(d=>{
    if(!mapa[d.categoria]) mapa[d.categoria] = new Set();
    mapa[d.categoria].add(d.piloto);
  });

  pilotosGlobal = mapa;

  renderizar(mapa);

});

function renderizar(mapa){

  const contenedor = document.getElementById("contenedor");
  contenedor.innerHTML = "";

  Object.keys(mapa).sort().forEach(cat=>{

    const div = document.createElement("div");
    div.className = "categoria";

    let html = `<h2>${cat} (${mapa[cat].size})</h2>`;
    html += `<div class="grid">`;

    [...mapa[cat]].sort().forEach(nombre=>{

      const nombreArchivo = nombre.replaceAll(" ","_");

      html += `
        <div class="card">
          <img src="../pilotos/${nombreArchivo}.jpg" 
               onerror="this.src='../pilotos/default.jpg'">
          <strong>${nombre}</strong><br>
          <a class="btn" href="../piloto.html?piloto=${encodeURIComponent(nombre)}&categoria=${encodeURIComponent(cat)}" target="_blank">
            Ver Ficha P√∫blica
          </a>
        </div>
      `;
    });

    html += `</div>`;
    div.innerHTML = html;

    contenedor.appendChild(div);
  });

}

// üîé Buscador
document.getElementById("buscador").addEventListener("input", function(){

  const texto = this.value.toLowerCase();

  const filtrado = {};

  Object.keys(pilotosGlobal).forEach(cat=>{
    const filtrados = [...pilotosGlobal[cat]]
      .filter(p=>p.toLowerCase().includes(texto));

    if(filtrados.length>0){
      filtrado[cat] = new Set(filtrados);
    }
  });

  renderizar(filtrado);

});
</script>

</body>
</html>
