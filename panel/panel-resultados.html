<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Resultados | PROKART</title>

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --rojo:#e10600;
  --negro:#111;
  --gris:#f4f4f4;
}

body{
  margin:0;
  font-family:'Oswald',Arial;
  background:var(--gris);
}

header{
  background:#000;
  color:#fff;
  padding:40px 20px;
  text-align:center;
}

section{
  max-width:900px;
  margin:auto;
  padding:40px 20px;
}

.card{
  background:#fff;
  padding:30px;
  border-radius:12px;
  box-shadow:0 5px 18px rgba(0,0,0,.15);
  margin-bottom:30px;
}

.btn{
  display:inline-block;
  margin-top:15px;
  padding:12px 18px;
  background:var(--rojo);
  color:#fff;
  text-decoration:none;
  border-radius:6px;
}

.stats p{
  margin:8px 0;
  font-size:18px;
}

.volver{
  text-align:center;
  margin-top:30px;
}
</style>
</head>

<body>

<header>
  <h1>Panel de Resultados</h1>
  <p>Control de Cargas Oficiales</p>
</header>

<section>

<div class="card">
  <h3>ðŸ“‹ Cargar Resultados</h3>
  <a class="btn" href="https://docs.google.com/forms/d/e/1FAIpQLSeYeX1MeBEeYgyWg-4HBE4UJS98ardXP7Po2TP39Yr9SCapYg/viewform?usp=preview" target="_blank">Abrir Formulario (Form B)</a>
</div>

<div class="card">
  <h3>ðŸ“„ Ver Sheet Oficial</h3>
  <a class="btn" href="https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhBGHo7TZ_jtqT0HXBvYaV3g1TYBN5lEfYfq2phY0vvHTEyVkTfrVy6RrotDcqVOxm5C4JX9CdTBp/pubhtml" target="_blank">
    Ver Hoja en Vivo
  </a>
</div>

<div class="card stats">
  <h3>ðŸ“Š Estado Actual</h3>
  <p><strong>Ãšltima fecha cargada:</strong> <span id="ultimaFecha">Cargando...</span></p>
  <p><strong>Pilotos en esa fecha:</strong> <span id="pilotosUltima">â€”</span></p>
  <p><strong>Total de registros en el aÃ±o:</strong> <span id="totalRegistros">â€”</span></p>
</div>

<div class="volver">
  <a class="btn" href="index.html">Volver al Panel</a>
</div>

</section>

<script src="auth.js"></script>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhBGHo7TZ_jtqT0HXBvYaV3g1TYBN5lEfYfq2phY0vvHTEyVkTfrVy6RrotDcqVOxm5C4JX9CdTBp/pub?gid=368482217&single=true&output=csv";

function limpiar(v){
  return v?.replace(/^"|"$/g,'').trim();
}

fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{

  const filas = csv.split(/\r?\n/).slice(1)
    .filter(f=>f.trim()!=='');

  document.getElementById("totalRegistros").textContent = filas.length;

  if(filas.length === 0){
    document.getElementById("ultimaFecha").textContent = "Sin datos";
    return;
  }

  const datos = filas.map(f=>{
    const col = f.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    return {
      fecha: limpiar(col[1]),
      piloto: limpiar(col[3])
    };
  });

  const fechas = [...new Set(datos.map(d=>d.fecha))];

  const ultima = fechas.sort((a,b)=>{
    const nA = parseInt(a.replace(/\D/g,''));
    const nB = parseInt(b.replace(/\D/g,''));
    return nB - nA;
  })[0];

  document.getElementById("ultimaFecha").textContent = ultima;

  const pilotosUltima = datos
    .filter(d=>d.fecha===ultima)
    .length;

  document.getElementById("pilotosUltima").textContent = pilotosUltima;

});
</script>

</body>
</html>
