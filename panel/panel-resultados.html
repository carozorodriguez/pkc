<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Resultados | PROKART</title>

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --rojo:#e10600;
  --negro:#111;
  --gris:#f4f4f4;
}

body{
  margin:0;
  font-family:'Oswald',Arial;
  background:var(--gris);
}

header{
  background:#000;
  color:#fff;
  padding:40px 20px;
  text-align:center;
}

section{
  max-width:900px;
  margin:auto;
  padding:40px 20px;
}

.card{
  background:#fff;
  padding:30px;
  border-radius:12px;
  box-shadow:0 5px 18px rgba(0,0,0,.15);
  margin-bottom:30px;
}

.btn{
  display:inline-block;
  margin-top:15px;
  padding:12px 18px;
  background:var(--rojo);
  color:#fff;
  text-decoration:none;
  border-radius:6px;
}

.stats p{
  margin:8px 0;
  font-size:18px;
}

.volver{
  text-align:center;
  margin-top:30px;
}
</style>
</head>

<body>

<header>
  <h1>Panel de Resultados</h1>
  <p>Control de Cargas Oficiales</p>
</header>

<section>

<div class="card">
  <h3>ğŸ“‹ Cargar Resultados</h3>
  <a class="btn" href="https://docs.google.com/forms/d/e/1FAIpQLSeYeX1MeBEeYgyWg-4HBE4UJS98ardXP7Po2TP39Yr9SCapYg/viewform?usp=preview" target="_blank">Abrir Formulario (Form B)</a>
</div>

<div class="card">
  <h3>ğŸ“„ Ver Sheet Oficial</h3>
  <a class="btn" href="https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhBGHo7TZ_jtqT0HXBvYaV3g1TYBN5lEfYfq2phY0vvHTEyVkTfrVy6RrotDcqVOxm5C4JX9CdTBp/pubhtml" target="_blank">
    Ver Hoja en Vivo
  </a>
</div>

<div class="card stats">
  <h3>ğŸ“Š Estado Actual</h3>
  <p><strong>Ãšltima fecha cargada:</strong> <span id="ultimaFecha">Cargando...</span></p>
  <p><strong>Pilotos en esa fecha:</strong> <span id="pilotosUltima">â€”</span></p>
  <p><strong>Total de registros en el aÃ±o:</strong> <span id="totalRegistros">â€”</span></p>
</div>

  <div class="card">
  <h3>ğŸ† Recalcular Campeonato</h3>
  <button class="btn" onclick="recalcular()">Recalcular Ahora</button>
  <div id="resultadoCampeonato" style="margin-top:20px;"></div>
</div>

<div class="volver">
  <a class="btn" href="index.html">Volver al Panel</a>
</div>

</section>

<script src="auth.js"></script>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhBGHo7TZ_jtqT0HXBvYaV3g1TYBN5lEfYfq2phY0vvHTEyVkTfrVy6RrotDcqVOxm5C4JX9CdTBp/pub?gid=368482217&single=true&output=csv";

function limpiar(v){
  return v?.replace(/^"|"$/g,'').trim();
}

fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{

  const filas = csv.split(/\r?\n/).slice(1)
    .filter(f=>f.trim()!=='');

  document.getElementById("totalRegistros").textContent = filas.length;

  if(filas.length === 0){
    document.getElementById("ultimaFecha").textContent = "Sin datos";
    return;
  }

  const datos = filas.map(f=>{
    const col = f.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    return {
      fecha: limpiar(col[1]),
      categoria: limpiar(col[2]),
      piloto: limpiar(col[3]),
      puntos: Number(limpiar(col[4])) || 0
    };
  });

  // ğŸ”¹ Ãšltima fecha
  const fechas = [...new Set(datos.map(d=>d.fecha))];

  const ultima = fechas.sort((a,b)=>{
    const nA = parseInt(a.replace(/\D/g,''));
    const nB = parseInt(b.replace(/\D/g,''));
    return nB - nA;
  })[0];

  document.getElementById("ultimaFecha").textContent = ultima;

  const datosUltima = datos.filter(d=>d.fecha===ultima);

  document.getElementById("pilotosUltima").textContent = datosUltima.length;

  // ğŸ”¹ CategorÃ­as en esa fecha
  const categoriasUltima = [...new Set(datosUltima.map(d=>d.categoria))];

  // ğŸ”¹ Piloto con mÃ¡s puntos en la fecha
  const ranking = {};
  datosUltima.forEach(d=>{
    ranking[d.piloto] = (ranking[d.piloto] || 0) + d.puntos;
  });

  const mejor = Object.entries(ranking)
    .sort((a,b)=>b[1]-a[1])[0];

  // ğŸ”¹ Duplicados
  const registrosUnicos = new Set();
  let duplicados = 0;

  datosUltima.forEach(d=>{
    const clave = d.fecha + d.categoria + d.piloto;
    if(registrosUnicos.has(clave)){
      duplicados++;
    } else {
      registrosUnicos.add(clave);
    }
  });

  // ğŸ”¹ Mostrar info extra
  const bloque = document.querySelector(".stats");

  bloque.innerHTML += `
    <p><strong>CategorÃ­as en la fecha:</strong> ${categoriasUltima.length}</p>
    <p><strong>MÃ¡ximo anotador:</strong> ${mejor ? mejor[0] + " (" + mejor[1] + " pts)" : "â€”"}</p>
    <p><strong>Posibles duplicados:</strong> ${duplicados}</p>
  `;

});
</script>
<script>
function recalcular(){

  const contenedor = document.getElementById("resultadoCampeonato");
  contenedor.innerHTML = "Calculando...";

  fetch(SHEET_URL)
  .then(r=>r.text())
  .then(csv=>{

    const filas = csv.split(/\r?\n/).slice(1)
      .filter(f=>f.trim()!=='');

    const datos = filas.map(f=>{
      const col = f.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
      return {
        categoria: limpiar(col[2]),
        piloto: limpiar(col[3]),
        puntos: Number(limpiar(col[4])) || 0
      };
    });

    const categorias = [...new Set(datos.map(d=>d.categoria))];

    let html = "";

    categorias.forEach(cat=>{

      const ranking = {};

      datos
        .filter(d=>d.categoria===cat)
        .forEach(d=>{
          ranking[d.piloto] = (ranking[d.piloto] || 0) + d.puntos;
        });

      const ordenado = Object.entries(ranking)
        .sort((a,b)=>b[1]-a[1]);

      if(ordenado.length===0) return;

      const lider = ordenado[0];
      const segundo = ordenado[1];

      const diferencia = segundo ? lider[1] - segundo[1] : 0;

      html += `
        <div style="margin-bottom:15px; padding:15px; background:#f4f4f4; border-radius:8px;">
          <strong>${cat}</strong><br>
          ğŸ¥‡ ${lider[0]} â€” ${lider[1]} pts<br>
          ${segundo ? `ğŸ¥ˆ ${segundo[0]} â€” ${segundo[1]} pts<br>
          Diferencia: ${diferencia} pts` : ""}
        </div>
      `;
    });

    contenedor.innerHTML = html || "Sin datos disponibles.";

  });
}
</script>


</body>
</html>
