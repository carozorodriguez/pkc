<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ficha del Piloto | PROKART CALETENSE</title>

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --rojo:#e10600;
  --negro:#111;
  --gris:#f4f4f4;
}

body{
  margin:0;
  font-family:'Oswald',Arial;
  background:var(--gris);
}

/* ===============================
   HEADER
================================ */
header{
  background:#000;
  color:#fff;
  text-align:center;
  padding:40px 20px;
}

/* ===============================
   CONTENIDO
================================ */
section{
  max-width:900px;
  margin:auto;
  padding:40px 20px;
}

.card{
  background:#fff;
  padding:30px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

.btn{
  display:inline-block;
  margin:10px 5px 0 0;
  padding:12px 18px;
  background:var(--rojo);
  color:#fff;
  text-decoration:none;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-family:'Oswald';
}

.btn:hover{opacity:.85}

/* ===============================
   DATOS PILOTO
================================ */
.piloto-header{
  display:grid;
  grid-template-columns:220px 1fr 160px;
  gap:30px;
  align-items:center;
}

.piloto-header img{
  width:100%;
  border-radius:12px;
  border:4px solid var(--negro);
}

#qrPiloto img{
  width:140px;
}

/* ===============================
   TITULOS
================================ */
h1{margin:0}
h3{
  margin-top:35px;
  border-left:5px solid var(--rojo);
  padding-left:12px;
}

/* ===============================
   TABLAS
================================ */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

th,td{
  padding:12px;
  border-bottom:1px solid #ddd;
  text-align:center;
}

th{
  background:var(--negro);
  color:#fff;
}

/* ===============================
   ACCIONES
================================ */
.acciones{
  margin-top:30px;
  text-align:center;
}

/* ===============================
   FOOTER
================================ */
footer{
  background:#000;
  color:#fff;
  text-align:center;
  padding:20px;
  margin-top:40px;
}

.sponsors img{
  height:45px;
  margin:0 10px;
}

/* ===============================
   IMPRESIÓN
================================ */
@media print{
  .acciones,
  footer{
    display:none;
  }
}
</style>
</head>

<body>

<header>
  <h1>Ficha del Piloto</h1>
</header>

<section>

<div class="card" id="fichaPiloto">

  <!-- DATOS PRINCIPALES -->
  <div class="piloto-header">
    <img id="fotoPiloto" src="" alt="Foto del piloto">

    <div>
      <h1 id="nombrePiloto"></h1>
      <p><strong>Categoría:</strong> <span id="categoriaPiloto"></span></p>
    </div>

    <div id="qrPiloto"></div>
  </div>

  <!-- ESTADÍSTICAS -->
  <h3>Estadísticas</h3>
  <table>
    <thead>
      <tr>
        <th>Carreras</th>
        <th>Puntos</th>
        <th>Mejor Puesto</th>
        <th>Promedio</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="statCarreras">0</td>
        <td id="statPuntos">0</td>
        <td id="statMejor">—</td>
        <td id="statPromedio">—</td>
      </tr>
    </tbody>
  </table>

  <!-- HISTORIAL -->
  <h3>Historial de Carreras</h3>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Puesto</th>
        <th>Puntos</th>
      </tr>
    </thead>
    <tbody id="tablaHistorial"></tbody>
  </table>

  <!-- ACCIONES -->
  <div class="acciones">
    <button class="btn" onclick="window.print()">🖨️ Imprimir / Exportar PDF</button>
    <a class="btn" href="index.html">⬅ Volver al Campeonato</a>
  </div>

</div>

</section>

<!-- FOOTER -->
<footer>
  <div class="sponsors">
    <img src="sponsors/vintage.png" alt="Vintage Motors 4T">
   <img src="sponsors/caleta.png" alt="Repuestos Santiago">
 <img src="sponsors/dany.png" alt="Dany Kart">
  </div>
  <p>© 2026 PROKART CALETENSE</p>
</footer>

<script>

/* ===============================
   PARAMETRO ID DESDE URL
================================ */
const params = new URLSearchParams(window.location.search);
const id = params.get("id"); // ejemplo: 200 Master_7

if(!id){
  document.getElementById("nombrePiloto").textContent = "Piloto no encontrado";
  throw new Error("ID no definido en URL");
}

const [categoria, numero] = id.split("_");

/* ===============================
   SHEETS
================================ */
const SHEET_RESULTADOS="https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhBGHo7TZ_jtqT0HXBvYaV3g1TYBN5lEfYfq2phY0vvHTEyVkTfrVy6RrotDcqVOxm5C4JX9CdTBp/pub?gid=368482217&single=true&output=csv";

const SHEET_PILOTOS="https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhBGHo7TZ_jtqT0HXBvYaV3g1TYBN5lEfYfq2phY0vvHTEyVkTfrVy6RrotDcqVOxm5C4JX9CdTBp/pub?gid=2063656949&single=true&output=csv";


function parseCSV(text){
  return text.split("\n").map(row =>
    row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
       .map(c => c.replace(/^"|"$/g,'').trim())
  );
}

/* ===============================
   CARGAR DATOS PILOTO
================================ */
async function cargarPiloto(){

  // ===== CARGAR BASE PILOTOS =====
  const rPil = await fetch(SHEET_PILOTOS);
  const tPil = await rPil.text();
  const fPil = parseCSV(tPil);

  const hPil = fPil[0];

  const iID   = hPil.indexOf("ID");
  const iNom  = hPil.indexOf("Nombre");
  const iFoto = hPil.indexOf("fotoURL");

  let nombrePiloto = "";
  let fotoURL = "";

  fPil.slice(1).forEach(f=>{
    if(f[iID] === id){
      nombrePiloto = f[iNom];
      fotoURL = f[iFoto];
    }
  });

  document.getElementById("nombrePiloto").textContent = nombrePiloto || id;
  document.getElementById("categoriaPiloto").textContent = categoria;

  const img = document.getElementById("fotoPiloto");

  if(fotoURL){
    img.src = fotoURL;
  }else{
    img.src = "pilotos/default.jpg";
  }

  img.onerror = () => img.src = "pilotos/default.jpg";


  // ===== CARGAR RESULTADOS =====
  const rRes = await fetch(SHEET_RESULTADOS);
  const tRes = await rRes.text();
  const fRes = parseCSV(tRes);

  const hRes = fRes[0];

  const iFecha = hRes.indexOf("Fecha");
  const iCat   = hRes.indexOf("Categoria");
  const iNum   = hRes.indexOf("Numero");
  const iPts   = hRes.indexOf("Puntos Obtenidos");

  const tabla = document.getElementById("tablaHistorial");

  let carreras = 0;
  let puntos = 0;
  let mejor = 999;
  let sumaPos = 0;

  const datosPiloto = fRes.slice(1).filter(f =>
    f[iCat] === categoria && f[iNum] === numero
  );

  datosPiloto.forEach(f => {

    const fecha = f[iFecha];
    const pts = Number(f[iPts]) || 0;

    carreras++;
    puntos += pts;

    // calcular puesto en esa fecha
    const fechaDatos = fRes.slice(1)
      .filter(x => x[iFecha] === fecha && x[iCat] === categoria)
      .map(x => ({
        numero: x[iNum],
        puntos: Number(x[iPts]) || 0
      }))
      .sort((a,b)=>b.puntos-a.puntos);

    const posicion = fechaDatos.findIndex(x => x.numero === numero) + 1;

    sumaPos += posicion;
    if(posicion < mejor) mejor = posicion;

    tabla.innerHTML += `
      <tr>
        <td>${fecha}</td>
        <td>${posicion}</td>
        <td>${pts}</td>
      </tr>
    `;
  });

  document.getElementById("statCarreras").textContent = carreras;
  document.getElementById("statPuntos").textContent = puntos;
  document.getElementById("statMejor").textContent = mejor === 999 ? "—" : mejor;
  document.getElementById("statPromedio").textContent =
    carreras ? (sumaPos/carreras).toFixed(2) : "—";

}

/* ===============================
   QR
================================ */
document.getElementById('qrPiloto').innerHTML =
  `<img src="https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(location.href)}">`;

cargarPiloto();

</script>

</body>
</html>
